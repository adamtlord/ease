{% extends 'rides/billing_base.html' %}
{% block header_includes %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/datatables-imports.css"/>
    <script type="text/javascript" src="{{ STATIC_URL }}DataTables/datatables.min.js"></script>
{% endblock %}

{% block title %}Ready to Bill{% endblock %}
{% block page_title %}Ready to Bill{% endblock %}

{% block rides_content %}

{% if results.total > 0 %}
    {% if results.errors|length > 0 %}
        <div class="alert alert-danger">
            {% for error in results.errors %}
                {{ error }}{% if not forloop.last %}<br />{% endif %}
            {% endfor %}
        </div>
    {% endif %}
    {% if results.success.billed|length > 0 or results.success.included|length > 0 %}
        <div class="alert alert-success">
            <dl>
                <dt>{{ results.success|length }} rides processed successfully</dt>
                {% if results.success.billed|length %}
                    <dd><em>Ride {% for id in results.success.billed %}{{ id }}{% if not forloop.last %}, {% endif %}{% endfor %} charged to the customer.</em></dd>
                {% endif %}
                {% if results.success.included|length %}
                    <dd><em>Ride {% for id in results.success.included %}{{ id }}{% if not forloop.last %}, {% endif %}{% endfor %} included in customer's plan and not invoiced.</em></dd>
                {% endif %}
            </dl>
        </div>
    {% endif %}
{% endif %}
<form id="bill_rides" action="" method="POST">{% csrf_token %}
    <div class="table-responsive">
        <table id="rides_to_bill" class="table table-hover">
            <thead>
                <tr>
                    <th><input class="master" type="checkbox"></tH>
                    <th>Cust.</th>
                    <th>ID</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Start Time</th>
                    <th>Distance</th>
                    <th>Cost</th>
                    <th>Total</th>
                    <th>Notes</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for customer,rides in customers.items %}
                    <tr class="customer">
                        <td><input class="customer" data-customer="{{ customer.id }}" type="checkbox"></td>
                        <th colspan="10">
                            <a href="{% url 'customer_history' customer.id %}">{{ customer }}</a>&nbsp;&nbsp;
                            {% if customer.plan %}
                                <span class="label plan-label {{ customer.plan.name|lower }}">{{ customer.plan }} Plan</span>
                            {% else %}
                                <span class="label label-danger">No Plan Selected</span>
                            {% endif %}
                            <small>ID {{ customer.id }}</small>
                        </th>
                    </tr>
                    {% for ride in rides %}
                        <tr class="ride">
                            <td></td>
                            <td><input class="customer_{{ ride.customer.id }}" name="ride" data-parent="{{ customer.id }}" value="{{ ride.id }}" type="checkbox"></td>
                            <td><a href="{% url 'ride_edit' ride.id %}">{{ ride.id }}</a></td>
                            <td>{{ ride.start.name }}</td>
                            <td>{{ ride.destination.name }}</td>
                            <td>{{ ride.start_date|date:"SHORT_DATETIME_FORMAT" }}</td>
                            <td>{{ ride.distance }} mi</td>
                            <td>${{ ride.cost }}</td>
                            <td>${{ ride.total_cost_estimate }}</td>
                            <td class="small">{% if ride.included_in_plan %}(included in plan) {% endif %}{{ ride.notes|default:'' }}</td>
                            <td><a href="{% url 'ride_edit' ride.id %}">Edit</a></td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="form-actions">
        <input type="submit" class="btn btn-primary btn-block" value="Bill Checked Rides" disabled="disabled" />
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="{{ STATIC_URL }}js/apps/ready_to_bill.min.js"></script>
{% endblock %}